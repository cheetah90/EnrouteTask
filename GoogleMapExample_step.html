<!DOCTYPE html>
<!Sychronous editing?>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <style>
      html, body, #map-canvas {
        height: 100%;
        margin: 0px;
        padding: 0px
      }
      #panel {
        position: absolute;
        top: 5px; 
        margin: auto;
        z-index: 5;
        background-color: #fff;
        padding: 5px;
        border: 1px solid #999;
      }
	  
	  #directions-panel {
        height: 100%;
        float: right;
        width: 350px;
        overflow: auto;
      }

      #map-canvas {
        margin-right: 350px;
      }
	  
	  @media print {
        #map-canvas {
          height: 500px;
          margin: 0;
        }

        #directions-panel {
          float: none;
          width: auto;
        }
      }
	  
    </style>
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBBj-LI45_3msjM7hqaAUl1hEj0J8fgidw&libraries=places&sensor=true"></script>
	<script type="text/javascript">
    	var directionsDisplay;
		var directionsService = new google.maps.DirectionsService(); 
		var map;  
		var start;
		var dest;
		var placesService;
		var marker;
		var placeInfoWindow;
		var establishmentType;
		var placesSearchRequest;
		
		var stepIter;
		var routeIter;
		var legIter;
		var tp_nearestEstablishmentObject;
		var nearestEstablishmentObject;
		var	detourTime;
		var exitIter;
	
		
		function initialize() {
			directionsDisplay = new google.maps.DirectionsRenderer();
			var mapOptions = {
			  center: new google.maps.LatLng(45, -93),
			  zoom: 13,
			  mapTypeId: google.maps.MapTypeId.ROADMAP
			}
			map = new google.maps.Map(document.getElementById("map-canvas"),mapOptions);
			
			directionsDisplay.setMap(map);
			directionsDisplay.setPanel(document.getElementById('directions-panel'));
			placesService = new google.maps.places.PlacesService(map);
			placeInfoWindow = new google.maps.InfoWindow();		
			
			//reset the global parameters
			exitIter=0;
			stepIter=0;
			routeIter=0;
			legIter=0;
			detourTime=9999;
			tp_nearestEstablishmentObject= new Object();
			nearestEstablishmentObject= new Object();
			
	 	}
		
		function calcRoute(){
			if(marker!=null)
			{
				marker.setMap(null);
				marker=null;
			}
			
			start = document.getElementById("origin").value;
			dest = document.getElementById("destination").value;
			
			var firstdirectonRequest={
				origin: start,
			  	destination: dest,
			  	travelMode: google.maps.TravelMode.DRIVING,
			  	unitSystem: google.maps.UnitSystem.METRIC,
				}
				
			directionsService.route(firstdirectonRequest, function(directionsResult, status){
				if (status==google.maps.DirectionsStatus.OK){
					IterateWayPoint(directionsResult);
				}				
			});		
		}
		
		function finalDirectionsServiceandRender(){
			var finalDirectonRequest={
				origin: start,
				destination: dest,
				travelMode: google.maps.TravelMode.DRIVING,
				unitSystem: google.maps.UnitSystem.METRIC,
				waypoints: [
				{
					location: nearestEstablishmentObject.geometry.location,
					stopover: false,
				}]
			}
		
			directionsService.route(finalDirectonRequest, function(finalDirectionsResult, status){
				if (status==google.maps.DirectionsStatus.OK){
					directionsDisplay.setDirections(finalDirectionsResult);
				}				
			});		
		}
		
		function createMarker(place) {
		  marker = new google.maps.Marker({
			map: map,
			position: place.geometry.location
		  });
		
		  google.maps.event.addListener(marker, 'click', function() {
			placeInfoWindow.setContent(place.name);
			placeInfoWindow.open(map, this);
		  });
		}
		
		
		function IterateWayPoint(directionsResult){
			establishmentType= document.getElementById("select_enroutetask").value;
			var searchCoord;
			
			searchCoord=directionsResult.routes[routeIter].legs[legIter].start_location; 
			placesSearchRequest = {
				location: searchCoord,
				types: [establishmentType],
				rankBy: google.maps.places.RankBy.DISTANCE,
			};			
			searchNearestEstablishment(placesSearchRequest,directionsResult);
			
		}
		
		function searchNearestEstablishment(placesSearchRequest,directionsResult){
			placesService.nearbySearch(placesSearchRequest, function(placesResults, status){
				if (status == google.maps.places.PlacesServiceStatus.OK)
				{	
					updatePlaceResultObject(tp_nearestEstablishmentObject,placesResults[0]);
					var compareDirectonRequest=
					{
						origin: placesSearchRequest.location,
						destination: tp_nearestEstablishmentObject.geometry.location,
						travelMode: google.maps.TravelMode.DRIVING,
						unitSystem: google.maps.UnitSystem.METRIC,
					}
									
					directionsService.route(compareDirectonRequest, function(compareDirectionsResult, status)
					{
						if (status==google.maps.DirectionsStatus.OK)
						{
							
							if(compareDirectionsResult.routes[0].legs[0].duration.value<detourTime)
							{
								detourTime=compareDirectionsResult.routes[0].legs[0].duration.value;
								updatePlaceResultObject(nearestEstablishmentObject,tp_nearestEstablishmentObject);
							}
							
							stepIter++;						
							if(stepIter>=directionsResult.routes[routeIter].legs[legIter].steps.length)
							{
								legIter++;
								stepIter=0;
								if(legIter>=directionsResult.routes[routeIter].legs.length)
								{
									routeIter++;
									legIter=0;
								}
							}	
	
							
							if(routeIter>=directionsResult.routes.length)
							{
								createMarker(nearestEstablishmentObject);
								finalDirectionsServiceandRender();
							}
							else
							{
								searchCoord=directionsResult.routes[routeIter].legs[legIter].steps[stepIter].end_point;
								placesSearchRequest = {
									location: searchCoord,
									types: [establishmentType],
									rankBy: google.maps.places.RankBy.DISTANCE,
								};								
								searchNearestEstablishment(placesSearchRequest,directionsResult);	
							}																																					
						}
					});		
				}
			});				
		};
		
		function updatePlaceResultObject(tobeupdated,update){
			tobeupdated.geometry= update.geometry;
			tobeupdated.icon=update.icon;
			tobeupdated.name=update.name;
			tobeupdated.vicinity=update.vicinity;
			}
		
      google.maps.event.addDomListener(window, 'load', initialize);
    </script>
  </head>
  <body>
  	<div id="panel">
  		Start: <input id="origin" type="text"> 
        End: <input id="destination"type="text"> 
        <b>With Doing</b>
        <select id="select_enroutetask">
        	<option value="grocery_or_supermarket">Grocery</option>
      		<option value="restaurant">Restaurant</option>
      		<option value="cafe">Coffee</option>
		</select>
        <b>Enroute</b>
        <input type="button" value="Submit" onClick="calcRoute();">
    </div>
    <div id="directions-panel"></div>  
  	<div id = "map-canvas"/>		
  </body>
</html>
