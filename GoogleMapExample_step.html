<!DOCTYPE html>
<!Sychronous editing?>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <style>
      html, body, #map-canvas {
        height: 100%;
        margin: 0px;
        padding: 0px
      }
      #panel {
        position: absolute;
        top: 5px; 
        margin: auto;
        z-index: 5;
        background-color: #fff;
        padding: 5px;
        border: 1px solid #999;
      }
	  
	  #directions-panel {
        height: 100%;
        float: right;
        width: 350px;
        overflow: auto;
      }

      #map-canvas {
        margin-right: 350px;
      }
	  
	  @media print {
        #map-canvas {
          height: 500px;
          margin: 0;
        }

        #directions-panel {
          float: none;
          width: auto;
        }
      }	  
    </style>    
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBBj-LI45_3msjM7hqaAUl1hEj0J8fgidw&libraries=places&sensor=true"></script>
    <script type="text/javascript">
    // JavaScript Document
	//Define the Global variables
	var directionsDisplay;
	var directionsService = new google.maps.DirectionsService(); 
	var map;  
	var start;
	var dest;
	var placesService;
	var placeInfoWindow;
	var establishmentType;
	var placesSearchRequest;
	
	//Those are the objects that need to be clean before each run
	var stepIter;
	var routeIter;
	var legIter;
	var tp_nearestEstablishmentObject;
	var nearestEstablishmentObject;
	var	detourTime;
	var markersArray=[]
	
	function initialize() {
		directionsDisplay = new google.maps.DirectionsRenderer({suppressMarkers:true});
		var mapOptions = {
		  center: new google.maps.LatLng(45, -93),
		  zoom: 13,
		  mapTypeId: google.maps.MapTypeId.ROADMAP
		}
		map = new google.maps.Map(document.getElementById("map-canvas"),mapOptions);
		
		directionsDisplay.setMap(map);
		
		//Add the panel that displays the turn by turn instruction, and the overall travelling time
		directionsDisplay.setPanel(document.getElementById('directions-panel'));
		
		//Initiate a placeService Object for Place Search, see later
		placesService = new google.maps.places.PlacesService(map);
		placeInfoWindow = new google.maps.InfoWindow();		
		
		
	}
	
	//The Main function of Route Calculation, called when user click "Submit"
	function calcRoute(){
		//If the marker on map is already created, delete is
		for (i = 0; i < markersArray.length; i++) {
		  markersArray[i].setMap(null);
		}
		markersArray=[];
		
		//reset the global parameters
		stepIter=0;	
		routeIter=0;
		legIter=0;
		detourTime=9999;
		tp_nearestEstablishmentObject= new Object();
		nearestEstablishmentObject= new Object();
		
		//Get the origin and destination from user input
		start = document.getElementById("origin").value;
		dest = document.getElementById("destination").value;
		
		//First, we search for the route JUST between origin and destination. We call that "the original route".
		var firstdirectonRequest={
			origin: start,
			destination: dest,
			travelMode: google.maps.TravelMode.DRIVING,
			unitSystem: google.maps.UnitSystem.METRIC,
			}	
		directionsService.route(firstdirectonRequest, function(directionsResult, status){
			if (status==google.maps.DirectionsStatus.OK){
				//In Google map api, directionResult would be the object that holds everything about the route. 
				//We are gonna parse directionResult to iterate each turns.
				IterateTurn(directionsResult);
			}				
		});		
	}
	
	function IterateTurn(directionsResult){
		//Get the type of establishment we are visiting en route from user input
		establishmentType= document.getElementById("select_enroutetask").value;
		
		//Get the START LOCATION of the route and search for the nearby establishment of selected type
		//We search the start location seperately because the start_location does not fit the general patterns of the other turn
		var searchCoord;			
		searchCoord=directionsResult.routes[routeIter].legs[legIter].start_location; //The way that Google Map organizes their direction result is as follow:
		// route[]  (which holds a set of alternative routes, if any)
		//		--legs[]	(which holds a set of routes between each pair of waypoint, if any)
		//				--step[]	(which contains the turns in turn-by-turn direction)
		
	
		//Construct the placeSearchRequest Object, which searches for the establishment of selected type near the Starting_Point, the result is ranked by distance to the search location 
		placesSearchRequest = {
			location: searchCoord,
			types: [establishmentType],
			rankBy: google.maps.places.RankBy.DISTANCE,
		};
		
					
		searchNearestEstablishment(placesSearchRequest,directionsResult);
		
	}
	 
	function searchNearestEstablishment(placesSearchRequest,directionsResult){
		//This is a recursive function, in the sense that it will call it self iteratively until the place search for establishment of selected type at each turns have been done. The reason for using a recursive function, rather than a straightforward for-loop, is that Google javascript relies on callback function to process the returned object of Place Service and Direction Service query, as a result, any code after the Place Service function and Direction Service will actually be processed before the place search result and direction search (routing) result are returned. 
		
		//Doing a place search near the location given by search request object
		placesService.nearbySearch(placesSearchRequest, function(placesResults, status){
			if (status == google.maps.places.PlacesServiceStatus.OK)
			{	
				
				updatePlaceResultObject(tp_nearestEstablishmentObject,placesResults[0]); //Since the establishment of selected type at specific location is ranked by distance, so the first one is the nearest one.
				
				//Query the travel time from the nearest establishment to the current turn (we call it detour time, since it is from the nearest establishment to a turn on the original route)
				var compareDirectonRequest=
				{
					origin: placesSearchRequest.location,
					destination: tp_nearestEstablishmentObject.geometry.location,
					travelMode: google.maps.TravelMode.DRIVING,
					unitSystem: google.maps.UnitSystem.METRIC,
				}
								
				directionsService.route(compareDirectonRequest, function(compareDirectionsResult, status)
				{
					if (status==google.maps.DirectionsStatus.OK)
					{
						
						//If the detour time is smaller than the recorded minimum detour time, update the smallest detour time
						if(compareDirectionsResult.routes[0].legs[0].duration.value<detourTime)
						{
							detourTime=compareDirectionsResult.routes[0].legs[0].duration.value;
							updatePlaceResultObject(nearestEstablishmentObject,tp_nearestEstablishmentObject);
						}
						
						//Since we are not using for-loop, so we have to do the i++ job ourselves
						stepIter++;					
						if(stepIter>=directionsResult.routes[routeIter].legs[legIter].steps.length)
						{
							legIter++;
							stepIter=0;
							if(legIter>=directionsResult.routes[routeIter].legs.length)
							{
								routeIter++;
								legIter=0;
							}
						}	
						
						//If we finish place search at every turn, create a marker at this recorded nearest establishment and do the final routing.
						if(routeIter>=directionsResult.routes.length)
						{
							finalDirectionsServiceandRender();
						}
						else	//if we have not finish places search at every turn, use next turn in the original route for nearest establishment search
						{
							searchCoord=directionsResult.routes[routeIter].legs[legIter].steps[stepIter].end_location;
							placesSearchRequest = {
								location: searchCoord,
								types: [establishmentType],
								rankBy: google.maps.places.RankBy.DISTANCE,
							};
							
							//recursively call the function itself								
							searchNearestEstablishment(placesSearchRequest,directionsResult);	
						}																																					
					}
				});		
			}
		});				
	};
	
	//Convenient function to update the place result object
	function updatePlaceResultObject(tobeupdated,update){
		tobeupdated.geometry= update.geometry;
		tobeupdated.icon=update.icon;
		tobeupdated.name=update.name;
		tobeupdated.vicinity=update.vicinity;
		}
	
	google.maps.event.addDomListener(window, 'load', initialize);
	
	//This is the final Direction Service, which use the original start location and original end location from user input, and the nearest establishment which has the minimum detour time as waypoint.
	function finalDirectionsServiceandRender(){
		var finalDirectionRequest={
			origin: start,
			destination: dest,
			travelMode: google.maps.TravelMode.DRIVING,
			unitSystem: google.maps.UnitSystem.METRIC,
			waypoints: [
			{
				location: nearestEstablishmentObject.geometry.location,
			}]
		}
	
		directionsService.route(finalDirectionRequest, function(finalDirectionsResult, status){
			if (status==google.maps.DirectionsStatus.OK){
				directionsDisplay.setDirections(finalDirectionsResult);
				createMarkers(nearestEstablishmentObject,finalDirectionsResult);
			}				
		});		
	}
	
	//Create Marker for the nearest establishment with minimum detour time.
	function createMarkers(place,finalDirection) {
	  var placemarker = new google.maps.Marker({
		map: map,
		position: place.geometry.location,
		icon: "https://mts.googleapis.com/vt/icon/name=icons/spotlight/spotlight-waypoint-a.png&text=B&psize=16&font=fonts/Roboto-Regular.ttf&color=ff333333&ax=44&ay=48&scale=1",
	  });
	  markersArray.push(placemarker);
	
	  google.maps.event.addListener(placemarker, 'click', function() {
		placeInfoWindow.setContent("<p><b>"+place.name+"</b></p>"+place.vicinity);
		placeInfoWindow.open(map, this);
	  });
	  
	  var startmarker = new google.maps.Marker({
		map: map,
		position: finalDirection.routes[0].legs[0].start_location,
		icon:"https://mts.googleapis.com/vt/icon/name=icons/spotlight/spotlight-waypoint-b.png&text=A&psize=16&font=fonts/Roboto-Regular.ttf&color=ff333333&ax=44&ay=48&scale=1"
	  });
	  markersArray.push(startmarker);
	
	  google.maps.event.addListener(startmarker, 'click', function() {
		placeInfoWindow.setContent(finalDirection.routes[0].legs[0].start_address);
		placeInfoWindow.open(map, this);
	  });
	  
	  var endmarker = new google.maps.Marker({
		map: map,
		position: finalDirection.routes[0].legs[1].end_location,
		icon:"https://mts.googleapis.com/vt/icon/name=icons/spotlight/spotlight-waypoint-b.png&text=C&psize=16&font=fonts/Roboto-Regular.ttf&color=ff333333&ax=44&ay=48&scale=1",
	  });
	  markersArray.push(endmarker);
	
	  google.maps.event.addListener(endmarker, 'click', function() {
		placeInfoWindow.setContent(finalDirection.routes[0].legs[1].end_address);
		placeInfoWindow.open(map, this);
		
	  });
	}  
	
    
    </script>    
  </head>
  <body>
  	<div id="panel">
  		Start: <input id="origin" type="text"> 
        End: <input id="destination"type="text"> 
        <b>With Doing</b>
        <select id="select_enroutetask">
        	<option value="grocery_or_supermarket">Grocery</option>
      		<option value="restaurant">Restaurant</option>
      		<option value="cafe">Coffee</option>
            <option value="gas_station">Gas Station</option>
            <option value="library">Library</option>
            <option value="pharmacy">Pharmacy</option>
            <option value="bank">Bank</option>
            
		</select>
        <b>Enroute</b>
        <input type="button" value="Submit" onClick="calcRoute();">
    </div>
    <div id="directions-panel"></div>  
  	<div id = "map-canvas"/>	
  </body>  
</html>
